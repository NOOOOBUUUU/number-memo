<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>番号記録ツール</title>

<style>
:root {
  --scale: 1;
}

body {
  margin: 0;
  padding: 8px;
  font-family: sans-serif;
  font-size: calc(16px * var(--scale));
}

/* 共通グリッド */
.row {
  display: grid;
  gap: 4px;
  margin-bottom: 6px;
}

/* タブ */
#tabs {
  grid-template-columns: repeat(5, 1fr);
}

/* 数字＋操作ボタン */
#buttons {
  grid-template-columns: repeat(5, 1fr);
}

/* ボタン */
button {
  aspect-ratio: 2 / 1;
  font-size: 1em;
}

/* 記録欄 */
textarea {
  width: 100%;
  resize: none;
  font-size: 1em;
  line-height: 1.4;
  white-space: pre-wrap;
  word-break: break-all;
}

/* 色 */
.tab-active { background: #2196f3; color: #fff; }
.tab-used { background: #ffeb3b; }

.btn-yellow { background: #ffeb3b; }
.btn-red { background: #f44336; color: #fff; }
</style>
</head>

<body>

<div class="row" id="tabs"></div>
<textarea id="record" readonly></textarea>
<div class="row" id="buttons"></div>

<script>
/* ===== 状態 ===== */
let tabs = Array.from({length:10}, (_,i)=>`${i+1}組`);
let currentTab = 0;
let lastInputTab = null;

let counts = Array.from({length:10}, ()=>Array(46).fill(0));
let history = [];
let snapshots = [];

let lineCount = 0; // ★ 1行の入力数

let fontIndex = 0;
const fontScales = [1, 1.5, 2];

/* ===== 自動保存 ===== */
function saveMain() {
  localStorage.setItem("record_main", JSON.stringify({
    tabs, counts, history, lastInputTab, lineCount
  }));
}

function saveWithBackup() {
  const current = localStorage.getItem("record_main");
  if (current) localStorage.setItem("record_backup", current);
  saveMain();
}

function restoreBackup() {
  const b = localStorage.getItem("record_backup");
  if (!b) {
    alert("バックアップがありません");
    return;
  }
  const d = JSON.parse(b);
  ({ tabs, counts, history, lastInputTab, lineCount } = d);
  renderAll();
}

/* ===== 描画 ===== */
function renderTabs() {
  const el = document.getElementById("tabs");
  el.innerHTML = "";

  tabs.forEach((name,i)=>{
    const b = document.createElement("button");
    b.textContent = name;

    if (i === currentTab) b.classList.add("tab-active");
    else if (counts[i].some(v=>v>0)) b.classList.add("tab-used");

    b.onclick = ()=>selectTab(i);
    el.appendChild(b);
  });
}

function renderButtons() {
  const el = document.getElementById("buttons");
  el.innerHTML = "";

  for (let i=1;i<=45;i++) {
    const b = document.createElement("button");
    b.textContent = String(i).padStart(2,"0");

    const c = counts[currentTab][i];
    if (c === 1) b.classList.add("btn-yellow");
    if (c >= 2) b.classList.add("btn-red");

    b.onclick = ()=>pressNumber(i);
    el.appendChild(b);
  }

  addBtn("戻る", undo);
  addBtn("不明", addUnknown);
  addBtn("コピー", copyRecord);
  addBtn("復元", restoreBackup);
  addBtn("クリア", clearRecord);
  addBtn("タブ名", renameTab);
  addBtn("文字", changeFont);
}

function addBtn(label, fn) {
  const b = document.createElement("button");
  b.textContent = label;
  b.onclick = fn;
  document.getElementById("buttons").appendChild(b);
}

function updateRecord() {
  const r = document.getElementById("record");
  r.value = history.join("");
  r.style.height = "auto";
  r.style.height = r.scrollHeight + "px";
}

/* ===== 操作 ===== */
function renderAll() {
  renderTabs();
  renderButtons();
  updateRecord();
  saveMain();
}

function selectTab(i) {
  currentTab = i;
  renderAll();
}

function saveSnapshot() {
  snapshots.push(JSON.parse(JSON.stringify({
    counts, history, lastInputTab, lineCount
  })));
}

function newLineIfNeeded() {
  if (lineCount >= 10) {
    history.push("\n");
    lineCount = 0;
  }
}

function pressNumber(n) {
  saveSnapshot();
  saveWithBackup();

  if (lastInputTab !== currentTab) {
    if (lastInputTab !== null) history.push("\n");
    history.push(`${tabs[currentTab]}: `);
    lastInputTab = currentTab;
    lineCount = 0;
  }

  counts[currentTab][n]++;
  const c = counts[currentTab][n];

  history.push(
    c===1
      ? `${String(n).padStart(2,"0")}, `
      : `${String(n).padStart(2,"0")}(${c}), `
  );

  lineCount++;
  newLineIfNeeded();
  renderAll();
}

function addUnknown() {
  saveSnapshot();
  saveWithBackup();

  if (lastInputTab !== currentTab) {
    if (lastInputTab !== null) history.push("\n");
    history.push(`${tabs[currentTab]}: `);
    lastInputTab = currentTab;
    lineCount = 0;
  }

  history.push("?, ");
  lineCount++;
  newLineIfNeeded();
  renderAll();
}

function undo() {
  if (!snapshots.length) return;
  saveWithBackup();

  const s = snapshots.pop();
  ({ counts, history, lastInputTab, lineCount } = s);
  renderAll();
}

function clearRecord() {
  saveWithBackup();
  counts = Array.from({length:10}, ()=>Array(46).fill(0));
  history = [];
  lastInputTab = null;
  lineCount = 0;
  renderAll();
}

function copyRecord() {
  navigator.clipboard.writeText(document.getElementById("record").value);
}

function renameTab() {
  const n = prompt("新しいタブ名（3文字まで）", tabs[currentTab]);
  if (n && n.length<=3) {
    saveWithBackup();
    tabs[currentTab] = n;
    renderAll();
  }
}

function changeFont() {
  fontIndex = (fontIndex+1)%3;
  document.documentElement.style.setProperty("--scale", fontScales[fontIndex]);
}

/* ===== 起動時復元 ===== */
window.addEventListener("load", ()=>{
  const saved = localStorage.getItem("record_main");
  if (saved) {
    const d = JSON.parse(saved);
    ({ tabs, counts, history, lastInputTab, lineCount } = d);
  }
  renderAll();
});
</script>

</body>
</html>
