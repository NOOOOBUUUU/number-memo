<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabbed Number Memo</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 8px;
  }

  h2 {
    text-align: center;
    margin: 8px 0;
  }

  .tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 8px;
    gap: 4px;
  }

  .tabs button {
    flex: 1;
    padding: 8px 0;
    font-size: 16px;
    cursor: pointer;
  }

  .tabs .active {
    background: #333;
    color: #fff;
  }

  .display {
    width: 100%;
    box-sizing: border-box;
    min-height: 90px;
    border: 1px solid #ccc;
    padding: 8px;
    margin-bottom: 8px;
    font-size: 18px;
    white-space: pre-line;
    word-break: break-all;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 6px;
    width: 100%;
  }

  button.num {
    aspect-ratio: 1 / 1;
    font-size: 20px;
    cursor: pointer;
  }

  button.once {
    background: orange;
  }

  button.multi {
    background: red;
    color: #fff;
  }

  .actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }

  .actions button {
    flex: 1;
    padding: 10px 0;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Number Memo</h2>

<div class="tabs" id="tabs"></div>

<div class="display" id="display"></div>

<div class="grid" id="grid"></div>

<div class="actions">
  <button id="undo">UNDO</button>
  <button id="copy">COPY</button>
  <button id="reset">RESET</button>
</div>

<script>
  const TAB_NAMES = ["A", "B", "C", "D", "E"];
  const MAX_NUMBER = 45;

  const tabsEl = document.getElementById("tabs");
  const gridEl = document.getElementById("grid");
  const displayEl = document.getElementById("display");

  let currentTab = "A";

  const tabCounts = {};
  TAB_NAMES.forEach(t => tabCounts[t] = {});

  const log = [];

  TAB_NAMES.forEach(t => {
    const btn = document.createElement("button");
    btn.textContent = t;
    btn.onclick = () => switchTab(t);
    if (t === currentTab) btn.classList.add("active");
    tabsEl.appendChild(btn);
  });

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll(".tabs button").forEach(b =>
      b.classList.toggle("active", b.textContent === tab)
    );
    renderButtons();
  }

  for (let i = 1; i <= MAX_NUMBER; i++) {
    const label = String(i).padStart(2, "0");
    const btn = document.createElement("button");
    btn.className = "num";
    btn.textContent = label;

    btn.onclick = () => {
      const counts = tabCounts[currentTab];
      counts[label] = (counts[label] || 0) + 1;

      log.push({
        tab: currentTab,
        num: label,
        count: counts[label]
      });

      renderAll();
    };

    gridEl.appendChild(btn);
  }

  function renderAll() {
    renderButtons();
    renderLog();
  }

  function renderButtons() {
    const counts = tabCounts[currentTab];
    document.querySelectorAll(".num").forEach(btn => {
      btn.classList.remove("once", "multi");
      const c = counts[btn.textContent];
      if (c === 1) btn.classList.add("once");
      if (c >= 2) btn.classList.add("multi");
    });
  }

  // ★ 改良された改行ルール
  function renderLog() {
    const lines = [];
    let currentLine = [];
    let lastTab = null;

    log.forEach((item, index) => {
      const text = item.count === 1
        ? `${item.tab}${item.num}`
        : `${item.tab}${item.num}(${item.count})`;

      // タブが変わったら改行
      if (lastTab && item.tab !== lastTab) {
        lines.push(currentLine);
        currentLine = [];
      }

      // 10項目ごとでも改行
      if (currentLine.length === 10) {
        lines.push(currentLine);
        currentLine = [];
      }

      currentLine.push(text);
      lastTab = item.tab;
    });

    if (currentLine.length) {
      lines.push(currentLine);
    }

    displayEl.textContent = lines.map(l => l.join(", ")).join("\n");
  }

  document.getElementById("undo").onclick = () => {
    if (!log.length) return;
    const last = log.pop();
    const counts = tabCounts[last.tab];
    counts[last.num]--;
    if (counts[last.num] <= 0) delete counts[last.num];
    renderAll();
  };

  document.getElementById("copy").onclick = () => {
    if (!displayEl.textContent) return;
    navigator.clipboard.writeText(displayEl.textContent);
    alert("コピーしました");
  };

  document.getElementById("reset").onclick = () => {
    TAB_NAMES.forEach(t => tabCounts[t] = {});
    log.length = 0;
    renderAll();
  };

  renderAll();
</script>

</body>
</html>
