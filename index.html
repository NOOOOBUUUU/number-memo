<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tab Counter App</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
  }

  .tabs {
    display: flex;
    width: 100%;
  }

  .tab, .add-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    border: none;
    font-size: 18px;
    background: #ddd;
    cursor: pointer;
  }

  .tab.active {
    background: #bbb;
    font-weight: bold;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    width: 100vw;
  }

  .btn {
    aspect-ratio: 1 / 1;
    font-size: 32px;
    border: 1px solid #999;
    background: #f5f5f5;
  }

  .orange { background: orange; }
  .red { background: red; color: #fff; }

  .controls {
    display: flex;
    width: 100%;
  }

  .controls button {
    flex: 1;
    padding: 12px;
    font-size: 18px;
  }

  .record {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    font-size: 16px;
    min-height: 120px;
    white-space: pre-wrap;
    border-top: 1px solid #ccc;
  }
</style>
</head>
<body>

<div class="tabs" id="tabs"></div>

<div class="grid" id="buttons"></div>

<div class="controls">
  <button onclick="undo()">UNDO</button>
  <button onclick="copyRecord()">COPY</button>
</div>

<div class="record" id="record"></div>

<script>
let tabs = [];
let activeTab = 0;
let record = [];
let pressCount = {};
let colorState = {};

function initTab(name) {
  tabs.push({ name });
  colorState[name] = {};
  renderTabs();
}

function renderTabs() {
  const el = document.getElementById('tabs');
  el.innerHTML = '';

  tabs.forEach((tab, i) => {
    const b = document.createElement('button');
    b.className = 'tab' + (i === activeTab ? ' active' : '');
    b.textContent = tab.name;
    b.onclick = () => {
      activeTab = i;
      renderTabs();
      renderButtons();
    };
    el.appendChild(b);
  });

  const add = document.createElement('button');
  add.className = 'add-tab';
  add.textContent = '+';
  add.onclick = addTab;
  el.appendChild(add);
}

function addTab() {
  const name = prompt('タブ名（半角英数字3文字まで）');
  if (!name) return;
  if (!/^[a-zA-Z0-9]{1,3}$/.test(name)) {
    alert('半角英数字1〜3文字のみ');
    return;
  }
  if (tabs.some(t => t.name === name)) {
    alert('同じ名前は使えません');
    return;
  }
  initTab(name);
}

function renderButtons() {
  const grid = document.getElementById('buttons');
  grid.innerHTML = '';

  for (let i = 1; i <= 45; i++) {
    const num = String(i).padStart(2, '0');
    const btn = document.createElement('button');
    btn.className = 'btn';

    const tabName = tabs[activeTab].name;
    const state = colorState[tabName][num] || 0;
    if (state === 1) btn.classList.add('orange');
    if (state >= 2) btn.classList.add('red');

    btn.textContent = num;
    btn.onclick = () => press(num);
    grid.appendChild(btn);
  }
}

function press(num) {
  const tab = tabs[activeTab].name;
  const key = tab + num;

  pressCount[key] = (pressCount[key] || 0) + 1;
  colorState[tab][num] = pressCount[key];

  let label = key;
  if (pressCount[key] >= 2) label += `(${pressCount[key]})`;

  record.push({ tab, num, label });
  renderRecord();
  renderButtons();
}

function renderRecord() {
  let out = '';
  let count = 0;
  let lastTab = null;

  record.forEach(r => {
    if (lastTab && lastTab !== r.tab) {
      out += '\n';
      count = 0;
    }
    out += r.label + ' ';
    count++;
    if (count >= 10) {
      out += '\n';
      count = 0;
    }
    lastTab = r.tab;
  });

  document.getElementById('record').textContent = out.trim();
}

function undo() {
  const r = record.pop();
  if (!r) return;

  const key = r.tab + r.num;
  pressCount[key]--;
  if (pressCount[key] <= 0) {
    delete pressCount[key];
    delete colorState[r.tab][r.num];
  }
  renderRecord();
  renderButtons();
}

function copyRecord() {
  navigator.clipboard.writeText(
    document.getElementById('record').textContent
  );
}

initTab('A');
renderButtons();
</script>

</body>
</html>
  button.multi {
    background: red;
    color: #fff;
  }

  .actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }

  .actions button {
    flex: 1;
    padding: 10px 0;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Number Memo</h2>

<div class="tabs" id="tabs"></div>

<div class="display" id="display"></div>

<div class="grid" id="grid"></div>

<div class="actions">
  <button id="undo">UNDO</button>
  <button id="copy">COPY</button>
  <button id="reset">RESET</button>
</div>

<script>
  const TAB_NAMES = ["A", "B", "C", "D", "E"];
  const MAX_NUMBER = 45;

  const tabsEl = document.getElementById("tabs");
  const gridEl = document.getElementById("grid");
  const displayEl = document.getElementById("display");

  let currentTab = "A";

  const tabCounts = {};
  TAB_NAMES.forEach(t => tabCounts[t] = {});

  const log = [];

  TAB_NAMES.forEach(t => {
    const btn = document.createElement("button");
    btn.textContent = t;
    btn.onclick = () => switchTab(t);
    if (t === currentTab) btn.classList.add("active");
    tabsEl.appendChild(btn);
  });

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll(".tabs button").forEach(b =>
      b.classList.toggle("active", b.textContent === tab)
    );
    renderButtons();
  }

  for (let i = 1; i <= MAX_NUMBER; i++) {
    const label = String(i).padStart(2, "0");
    const btn = document.createElement("button");
    btn.className = "num";
    btn.textContent = label;

    btn.onclick = () => {
      const counts = tabCounts[currentTab];
      counts[label] = (counts[label] || 0) + 1;

      log.push({
        tab: currentTab,
        num: label,
        count: counts[label]
      });

      renderAll();
    };

    gridEl.appendChild(btn);
  }

  function renderAll() {
    renderButtons();
    renderLog();
  }

  function renderButtons() {
    const counts = tabCounts[currentTab];
    document.querySelectorAll(".num").forEach(btn => {
      btn.classList.remove("once", "multi");
      const c = counts[btn.textContent];
      if (c === 1) btn.classList.add("once");
      if (c >= 2) btn.classList.add("multi");
    });
  }

  // ★ 改良された改行ルール
  function renderLog() {
    const lines = [];
    let currentLine = [];
    let lastTab = null;

    log.forEach((item, index) => {
      const text = item.count === 1
        ? `${item.tab}${item.num}`
        : `${item.tab}${item.num}(${item.count})`;

      // タブが変わったら改行
      if (lastTab && item.tab !== lastTab) {
        lines.push(currentLine);
        currentLine = [];
      }

      // 10項目ごとでも改行
      if (currentLine.length === 10) {
        lines.push(currentLine);
        currentLine = [];
      }

      currentLine.push(text);
      lastTab = item.tab;
    });

    if (currentLine.length) {
      lines.push(currentLine);
    }

    displayEl.textContent = lines.map(l => l.join(", ")).join("\n");
  }

  document.getElementById("undo").onclick = () => {
    if (!log.length) return;
    const last = log.pop();
    const counts = tabCounts[last.tab];
    counts[last.num]--;
    if (counts[last.num] <= 0) delete counts[last.num];
    renderAll();
  };

  document.getElementById("copy").onclick = () => {
    if (!displayEl.textContent) return;
    navigator.clipboard.writeText(displayEl.textContent);
    alert("コピーしました");
  };

  document.getElementById("reset").onclick = () => {
    TAB_NAMES.forEach(t => tabCounts[t] = {});
    log.length = 0;
    renderAll();
  };

  renderAll();
</script>

</body>
</html>
